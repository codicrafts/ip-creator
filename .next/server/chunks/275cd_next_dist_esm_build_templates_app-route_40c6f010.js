module.exports=[97619,e=>{"use strict";let t,a;var s=e.i(14068),n=e.i(17450),r=e.i(32375),o=e.i(93485),i=e.i(1641),u=e.i(20496),d=e.i(53856),c=e.i(64168),l=e.i(38556),p=e.i(80163),g=e.i(78399),m=e.i(43280),h=e.i(91147),R=e.i(80896),f=e.i(74450),w=e.i(18772),E=e.i(93695);e.i(92909);var N=e.i(68518),x=e.i(11027);function v(){let e=new Date,t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${t}-${a}-${s}`}function y(e){if(e instanceof Date){let t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${t}-${a}-${s}`}let t=new Date(e);if(!isNaN(t.getTime())){let e=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");return`${e}-${a}-${s}`}if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;let a=e.split(/[\/\-]/);if(3===a.length){let e,t,s;return 4===a[0].length?(e=a[0],t=a[1].padStart(2,"0"),s=a[2].padStart(2,"0")):(t=a[0].padStart(2,"0"),s=a[1].padStart(2,"0"),e=a[2]),`${e}-${t}-${s}`}return e}async function U(){if(!t){let s=await e.A(40233);t=s.default||s;let n={env:"cloudbase-5gqcz0ab010d3288"},r=process.env.TENCENT_CLOUD_SECRET_ID,o=process.env.TENCENT_CLOUD_SECRET_KEY;r&&o&&(n.secretId=r,n.secretKey=o),t.init(n),a=t.database()}return{cloud:t,db:a}}async function T(e,{params:t}){try{let{db:a}=await U(),s=(await t).functionName,n=await e.json();if("auth"===s)return await S(n,a);if("user"===s)return await C(n,a);if("history"===s)return await D(n,a);else return x.NextResponse.json({success:0,message:"未知的云函数"},{status:400})}catch(e){return console.error("调用云函数失败:",e),x.NextResponse.json({success:0,message:e.message||"调用云函数失败"},{status:500})}}async function S(e,t){let{action:a,phone:s,password:n}=e;if("login"===a){let e,a=await t.collection("users").where({phone:s}).get();if(0===a.data.length){let a=v(),r={phone:s,password:n,userTier:"FREE",sceneUsage:{date:a,count:0},memeUsage:{date:a,count:0},createdAt:new Date,updatedAt:new Date};e={_id:(await t.collection("users").add({data:r}))._id,...r}}else if((e=a.data[0]).password!==n)return x.NextResponse.json({success:0,message:"密码错误"});return x.NextResponse.json({success:1,data:{userId:e._id,phone:e.phone,userTier:e.userTier||"FREE",sceneUsage:e.sceneUsage||{date:new Date().toLocaleDateString(),count:0},memeUsage:e.memeUsage||{date:new Date().toLocaleDateString(),count:0}}})}if("register"!==a)return x.NextResponse.json({success:0,message:"未知操作"});{if((await t.collection("users").where({phone:s}).get()).data.length>0)return x.NextResponse.json({success:0,message:"该手机号已注册"});let e=v(),a={phone:s,password:n,userTier:"FREE",sceneUsage:{date:e,count:0},memeUsage:{date:e,count:0},createdAt:new Date,updatedAt:new Date},r=await t.collection("users").add({data:a});return x.NextResponse.json({success:1,data:{userId:r._id,phone:a.phone,userTier:a.userTier,sceneUsage:a.sceneUsage,memeUsage:a.memeUsage}})}}async function C(e,t){let{action:a,userId:s,increment:n,userTier:r}=e;if(!s)return x.NextResponse.json({success:0,message:"用户ID不能为空"});let o=v();if("getInfo"===a){let e=await t.collection("users").doc(s).get();if(!e.data)return x.NextResponse.json({success:0,message:"用户不存在"});let a=e.data,n=a.sceneUsage||{date:o,count:0},r=a.memeUsage||{date:o,count:0},i=y(n.date),u=y(r.date);return n=i!==o?{date:o,count:0}:{...n,date:o},r=u!==o?{date:o,count:0}:{...r,date:o},x.NextResponse.json({success:1,data:{userId:a._id,phone:a.phone,userTier:a.userTier||"FREE",sceneUsage:n,memeUsage:r}})}if("updateSceneUsage"===a){let e=await t.collection("users").doc(s).get();if(!e.data)return x.NextResponse.json({success:0,message:"用户不存在"});let a=e.data.sceneUsage||{date:o,count:0};return y(a.date)!==o?a={date:o,count:n||1}:(a.count=(a.count||0)+(n||1),a.date=o),await t.collection("users").doc(s).update({data:{sceneUsage:a,updatedAt:new Date}}),x.NextResponse.json({success:1,data:{sceneUsage:a}})}if("updateMemeUsage"===a){let e=await t.collection("users").doc(s).get();if(!e.data)return x.NextResponse.json({success:0,message:"用户不存在"});let a=e.data.memeUsage||{date:o,count:0};return y(a.date)!==o?a={date:o,count:n||1}:(a.count=(a.count||0)+(n||1),a.date=o),await t.collection("users").doc(s).update({data:{memeUsage:a,updatedAt:new Date}}),x.NextResponse.json({success:1,data:{memeUsage:a}})}{if("updateTier"!==a)return x.NextResponse.json({success:0,message:"未知操作"});await t.collection("users").doc(s).update({data:{userTier:r,updatedAt:new Date}});let e=(await t.collection("users").doc(s).get()).data;return x.NextResponse.json({success:1,data:{userId:e._id,phone:e.phone,userTier:e.userTier,sceneUsage:e.sceneUsage||{date:o,count:0},memeUsage:e.memeUsage||{date:o,count:0}}})}}async function D(e,t){let{action:a,userId:s,type:n,url:r,prompt:o,style:i,historyId:u,limit:d}=e;if("save"===a){let e={userId:s||null,type:n,url:r,prompt:o,style:i||null,timestamp:Date.now(),createdAt:new Date,updatedAt:new Date},a=await t.collection("history").add({data:e});return x.NextResponse.json({success:1,data:{id:a._id,userId:e.userId,type:e.type,url:e.url,prompt:e.prompt,style:e.style,timestamp:e.timestamp}})}if("getList"===a){if(!s)return x.NextResponse.json({success:0,message:"用户ID不能为空"});let e=t.collection("history").where({userId:s}).orderBy("timestamp","desc").limit(d||50),a=(await e.get()).data.map(e=>({id:e._id,userId:e.userId,type:e.type,url:e.url,prompt:e.prompt,style:e.style,timestamp:e.timestamp}));return x.NextResponse.json({success:1,data:a})}if("delete"!==a)return x.NextResponse.json({success:0,message:"未知操作"});{if(!s||!u)return x.NextResponse.json({success:0,message:"用户ID和历史记录ID不能为空"});let e=(await t.collection("history").doc(u).get()).data;return e?e.userId!==s?x.NextResponse.json({success:0,message:"无权删除该历史记录"}):(await t.collection("history").doc(u).remove(),x.NextResponse.json({success:1,message:"删除成功"})):x.NextResponse.json({success:0,message:"历史记录不存在"})}}e.s(["POST",()=>T],1012);var A=e.i(1012);let _=new s.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/cloud/[functionName]/route",pathname:"/api/cloud/[functionName]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/cloud/[functionName]/route.ts",nextConfigOutput:"",userland:A}),{workAsyncStorage:I,workUnitAsyncStorage:j,serverHooks:b}=_;function O(){return(0,r.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:j})}async function P(e,t,a){_.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let s="/api/cloud/[functionName]/route";s=s.replace(/\/index$/,"")||"/";let r=await _.prepare(e,t,{srcPage:s,multiZoneDraftMode:!1});if(!r)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:x,params:v,nextConfig:y,parsedUrl:U,isDraftMode:T,prerenderManifest:S,routerServerContext:C,isOnDemandRevalidate:D,revalidateOnlyGenerated:A,resolvedPathname:I,clientReferenceManifest:j,serverActionsManifest:b}=r,O=(0,c.normalizeAppPath)(s),P=!!(S.dynamicRoutes[O]||S.routes[I]),$=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,U,!1):t.end("This page could not be found"),null);if(P&&!T){let e=!!S.routes[I],t=S.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await $();throw new E.NoFallbackError}}let M=null;!P||_.isDev||T||(M="/index"===(M=I)?"/":M);let H=!0===_.isDev||!P,q=P&&!H;b&&j&&(0,u.setReferenceManifestsSingleton)({page:s,clientReferenceManifest:j,serverActionsManifest:b,serverModuleMap:(0,d.createServerModuleMap)({serverActionsManifest:b})});let F=e.method||"GET",k=(0,i.getTracer)(),K=k.getActiveScopeSpan(),L={params:v,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,s)=>_.onRequestError(e,t,s,C)},sharedContext:{buildId:x}},B=new l.NodeNextRequest(e),Y=new l.NodeNextResponse(t),G=p.NextRequestAdapter.fromNodeNextRequest(B,(0,p.signalFromNodeResponse)(t));try{let r=async e=>_.handle(G,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=k.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==g.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let t=`${F} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${s}`)}),u=!!(0,o.getRequestMeta)(e,"minimalMode"),d=async o=>{var i,d;let c=async({previousCacheEntry:n})=>{try{if(!u&&D&&A&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await r(o);e.fetchMetrics=L.renderOpts.fetchMetrics;let i=L.renderOpts.pendingWaitUntil;i&&a.waitUntil&&(a.waitUntil(i),i=void 0);let d=L.renderOpts.collectedTags;if(!P)return await (0,h.sendResponse)(B,Y,s,L.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,R.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[w.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,n=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:N.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await _.onRequestError(e,t,{routerKind:"App Router",routePath:s,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:D})},C),t}},l=await _.handleResponse({req:e,nextConfig:y,cacheKey:M,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:D,revalidateOnlyGenerated:A,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:u});if(!P)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==N.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(d=l.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});u||t.setHeader("x-nextjs-cache",D?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,R.fromNodeOutgoingHttpHeaders)(l.value.headers);return u&&P||p.delete(w.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,f.getCacheControlHeader)(l.cacheControl)),await (0,h.sendResponse)(B,Y,new Response(l.value.body,{headers:p,status:l.value.status||200})),null};K?await d(K):await k.withPropagatedContext(e.headers,()=>k.trace(g.BaseServerSpan.handleRequest,{spanName:`${F} ${s}`,kind:i.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},d))}catch(t){if(t instanceof E.NoFallbackError||await _.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:D})}),P)throw t;return await (0,h.sendResponse)(B,Y,new Response(null,{status:500})),null}}e.s(["handler",()=>P,"patchFetch",()=>O,"routeModule",()=>_,"serverHooks",()=>b,"workAsyncStorage",()=>I,"workUnitAsyncStorage",()=>j],97619)}];

//# sourceMappingURL=275cd_next_dist_esm_build_templates_app-route_40c6f010.js.map
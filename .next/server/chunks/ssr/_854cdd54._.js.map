{"version":3,"sources":["../../../../lib/db.ts"],"sourcesContent":["/**\n * 数据库操作共享函数\n * 供 SSR 和 API 路由使用\n */\n\nimport { UserTier } from '@/types';\nimport { getTodayDateString, normalizeDateString } from '@/lib/date-utils';\n\n// 动态导入 wx-server-sdk（CommonJS 模块）\nlet cloudInstance: any;\nlet dbInstance: any;\n\nexport async function getCloudDB() {\n  if (!cloudInstance) {\n    // 使用动态导入处理 CommonJS 模块\n    const wxServerSDK = await import(\"wx-server-sdk\");\n    cloudInstance = (wxServerSDK as any).default || wxServerSDK;\n\n    // 配置云开发（需要 secretId 和 secretKey）\n    const initConfig: any = {\n      env: \"cloudbase-5gqcz0ab010d3288\",\n    };\n\n    // 从环境变量获取腾讯云凭证（如果配置了）\n    const secretId = process.env.TENCENT_CLOUD_SECRET_ID;\n    const secretKey = process.env.TENCENT_CLOUD_SECRET_KEY;\n\n    if (secretId && secretKey) {\n      initConfig.secretId = secretId;\n      initConfig.secretKey = secretKey;\n    }\n\n    cloudInstance.init(initConfig);\n    dbInstance = cloudInstance.database();\n  }\n  return { cloud: cloudInstance, db: dbInstance };\n}\n\n/**\n * 获取用户信息（返回普通对象，不包含 NextResponse）\n */\nexport async function getUserInfoFromDB(userId: string) {\n  try {\n    const { db } = await getCloudDB();\n    const today = getTodayDateString();\n\n    const result = await db.collection(\"users\").doc(userId).get();\n\n    if (!result.data) {\n      return null;\n    }\n\n    const user = result.data;\n\n    // 检查是否需要重置每日使用量\n    let sceneUsage = user.sceneUsage || { date: today, count: 0 };\n    let memeUsage = user.memeUsage || { date: today, count: 0 };\n\n    // 统一日期格式后比较\n    const sceneUsageDate = normalizeDateString(sceneUsage.date);\n    const memeUsageDate = normalizeDateString(memeUsage.date);\n\n    if (sceneUsageDate !== today) {\n      sceneUsage = { date: today, count: 0 };\n    } else {\n      // 确保日期格式统一\n      sceneUsage = { ...sceneUsage, date: today };\n    }\n    if (memeUsageDate !== today) {\n      memeUsage = { date: today, count: 0 };\n    } else {\n      // 确保日期格式统一\n      memeUsage = { ...memeUsage, date: today };\n    }\n\n    return {\n      userId: user._id,\n      phone: user.phone,\n      userTier: (user.userTier || \"FREE\") as UserTier,\n      sceneUsage: sceneUsage,\n      memeUsage: memeUsage,\n    };\n  } catch (error) {\n    console.error(\"Get user info from DB error:\", error);\n    return null;\n  }\n}\n\n"],"names":[],"mappings":"2CASI,EACA,EAJJ,IAAA,EAAA,EAAA,CAAA,CAAA,OAMO,eAAe,IACpB,GAAI,CAAC,EAAe,CAElB,IAAM,EAAc,MAAA,EAAA,CAAA,CAAA,OACpB,EAAiB,EAAoB,OAAO,EAAI,EAGhD,IAAM,EAAkB,CACtB,IAAK,4BACP,EAGM,EAAW,QAAQ,GAAG,CAAC,uBAAuB,CAC9C,EAAY,QAAQ,GAAG,CAAC,wBAAwB,CAElD,GAAY,IACd,EAAW,KADc,GACN,CAAG,EACtB,EAAW,SAAS,CAAG,GAGzB,EAAc,IAAI,CAAC,GACnB,EAAa,EAAc,QAAQ,EACrC,CACA,MAAO,CAAE,MAAO,EAAe,GAAI,CAAW,CAChD,CAKO,eAAe,EAAkB,CAAc,EACpD,GAAI,CACF,GAAM,CAAE,IAAE,CAAE,CAAG,MAAM,IACf,EAAQ,CAAA,EAAA,EAAA,kBAAA,AAAkB,IAE1B,EAAS,MAAM,EAAG,UAAU,CAAC,SAAS,GAAG,CAAC,GAAQ,GAAG,GAE3D,GAAI,CAAC,EAAO,IAAI,CACd,CADgB,MACT,KAGT,IAAM,EAAO,EAAO,IAAI,CAGpB,EAAa,EAAK,UAAU,EAAI,CAAE,KAAM,EAAO,MAAO,CAAE,EACxD,EAAY,EAAK,SAAS,EAAI,CAAE,KAAM,EAAO,MAAO,CAAE,EAGpD,EAAiB,CAAA,EAAA,EAAA,mBAAA,AAAmB,EAAC,EAAW,IAAI,EACpD,EAAgB,CAAA,EAAA,EAAA,mBAAA,AAAmB,EAAC,EAAU,IAAI,EAexD,OAZE,EADE,IAAmB,EACR,CAAE,IADa,CACP,EAAO,MAAO,CAAE,EAGxB,CAAE,GAAG,CAAU,CAAE,KAAM,CAAM,EAG1C,EADE,IAAkB,EACR,CAAE,IADa,CACP,EAAO,MAAO,CAAE,EAGxB,CAAE,GAAG,CAAS,CAAE,KAAM,CAAM,EAGnC,CACL,OAAQ,EAAK,GAAG,CAChB,MAAO,EAAK,KAAK,CACjB,SAAW,EAAK,QAAQ,EAAI,OAC5B,WAAY,EACZ,UAAW,CACb,CACF,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,+BAAgC,GACvC,IACT,CACF"}
{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/weili/work/generate-web/lib/db.ts"],"sourcesContent":["/**\n * 数据库操作共享函数\n * 供 SSR 和 API 路由使用\n */\n\nimport { UserTier } from '@/types';\nimport { getTodayDateString, normalizeDateString } from '@/lib/date-utils';\n\n// 动态导入 wx-server-sdk（CommonJS 模块）\nlet cloudInstance: any;\nlet dbInstance: any;\n\nexport async function getCloudDB() {\n  if (!cloudInstance) {\n    // 使用动态导入处理 CommonJS 模块\n    const wxServerSDK = await import(\"wx-server-sdk\");\n    cloudInstance = (wxServerSDK as any).default || wxServerSDK;\n\n    // 配置云开发（需要 secretId 和 secretKey）\n    const initConfig: any = {\n      env: \"cloudbase-5gqcz0ab010d3288\",\n    };\n\n    // 从环境变量获取腾讯云凭证（如果配置了）\n    const secretId = process.env.TENCENT_CLOUD_SECRET_ID;\n    const secretKey = process.env.TENCENT_CLOUD_SECRET_KEY;\n\n    if (secretId && secretKey) {\n      initConfig.secretId = secretId;\n      initConfig.secretKey = secretKey;\n    }\n\n    cloudInstance.init(initConfig);\n    dbInstance = cloudInstance.database();\n  }\n  return { cloud: cloudInstance, db: dbInstance };\n}\n\n/**\n * 获取用户信息（返回普通对象，不包含 NextResponse）\n */\nexport async function getUserInfoFromDB(userId: string) {\n  try {\n    const { db } = await getCloudDB();\n    const today = getTodayDateString();\n\n    const result = await db.collection(\"users\").doc(userId).get();\n\n    if (!result.data) {\n      return null;\n    }\n\n    const user = result.data;\n\n    // 检查是否需要重置每日使用量\n    let sceneUsage = user.sceneUsage || { date: today, count: 0 };\n    let memeUsage = user.memeUsage || { date: today, count: 0 };\n\n    // 统一日期格式后比较\n    const sceneUsageDate = normalizeDateString(sceneUsage.date);\n    const memeUsageDate = normalizeDateString(memeUsage.date);\n\n    if (sceneUsageDate !== today) {\n      sceneUsage = { date: today, count: 0 };\n    } else {\n      // 确保日期格式统一\n      sceneUsage = { ...sceneUsage, date: today };\n    }\n    if (memeUsageDate !== today) {\n      memeUsage = { date: today, count: 0 };\n    } else {\n      // 确保日期格式统一\n      memeUsage = { ...memeUsage, date: today };\n    }\n\n    return {\n      userId: user._id,\n      phone: user.phone,\n      userTier: (user.userTier || \"FREE\") as UserTier,\n      sceneUsage: sceneUsage,\n      memeUsage: memeUsage,\n    };\n  } catch (error) {\n    console.error(\"Get user info from DB error:\", error);\n    return null;\n  }\n}\n\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;AAGD;;AAEA,kCAAkC;AAClC,IAAI;AACJ,IAAI;AAEG,eAAe;IACpB,IAAI,CAAC,eAAe;QAClB,uBAAuB;QACvB,MAAM,cAAc;QACpB,gBAAgB,AAAC,YAAoB,OAAO,IAAI;QAEhD,iCAAiC;QACjC,MAAM,aAAkB;YACtB,KAAK;QACP;QAEA,sBAAsB;QACtB,MAAM,WAAW,QAAQ,GAAG,CAAC,uBAAuB;QACpD,MAAM,YAAY,QAAQ,GAAG,CAAC,wBAAwB;QAEtD,IAAI,YAAY,WAAW;YACzB,WAAW,QAAQ,GAAG;YACtB,WAAW,SAAS,GAAG;QACzB;QAEA,cAAc,IAAI,CAAC;QACnB,aAAa,cAAc,QAAQ;IACrC;IACA,OAAO;QAAE,OAAO;QAAe,IAAI;IAAW;AAChD;AAKO,eAAe,kBAAkB,MAAc;IACpD,IAAI;QACF,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM;QACrB,MAAM,QAAQ,IAAA,0IAAkB;QAEhC,MAAM,SAAS,MAAM,GAAG,UAAU,CAAC,SAAS,GAAG,CAAC,QAAQ,GAAG;QAE3D,IAAI,CAAC,OAAO,IAAI,EAAE;YAChB,OAAO;QACT;QAEA,MAAM,OAAO,OAAO,IAAI;QAExB,gBAAgB;QAChB,IAAI,aAAa,KAAK,UAAU,IAAI;YAAE,MAAM;YAAO,OAAO;QAAE;QAC5D,IAAI,YAAY,KAAK,SAAS,IAAI;YAAE,MAAM;YAAO,OAAO;QAAE;QAE1D,YAAY;QACZ,MAAM,iBAAiB,IAAA,2IAAmB,EAAC,WAAW,IAAI;QAC1D,MAAM,gBAAgB,IAAA,2IAAmB,EAAC,UAAU,IAAI;QAExD,IAAI,mBAAmB,OAAO;YAC5B,aAAa;gBAAE,MAAM;gBAAO,OAAO;YAAE;QACvC,OAAO;YACL,WAAW;YACX,aAAa;gBAAE,GAAG,UAAU;gBAAE,MAAM;YAAM;QAC5C;QACA,IAAI,kBAAkB,OAAO;YAC3B,YAAY;gBAAE,MAAM;gBAAO,OAAO;YAAE;QACtC,OAAO;YACL,WAAW;YACX,YAAY;gBAAE,GAAG,SAAS;gBAAE,MAAM;YAAM;QAC1C;QAEA,OAAO;YACL,QAAQ,KAAK,GAAG;YAChB,OAAO,KAAK,KAAK;YACjB,UAAW,KAAK,QAAQ,IAAI;YAC5B,YAAY;YACZ,WAAW;QACb;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,OAAO;IACT;AACF"}}]
}
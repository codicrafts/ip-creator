{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/weili/work/generate-web/app/api/cloud/%5BfunctionName%5D/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\n\n// 动态导入 wx-server-sdk（CommonJS 模块）\nlet cloudInstance: any;\nlet dbInstance: any;\n\nasync function getCloudDB() {\n  if (!cloudInstance) {\n    // 使用动态导入处理 CommonJS 模块\n    const wxServerSDK = await import(\"wx-server-sdk\");\n    cloudInstance = (wxServerSDK as any).default || wxServerSDK;\n\n    // 配置云开发（需要 secretId 和 secretKey）\n    const initConfig: any = {\n      env: \"cloudbase-5gqcz0ab010d3288\",\n    };\n\n    // 从环境变量获取腾讯云凭证（如果配置了）\n    const secretId = process.env.TENCENT_CLOUD_SECRET_ID;\n    const secretKey = process.env.TENCENT_CLOUD_SECRET_KEY;\n\n    if (secretId && secretKey) {\n      initConfig.secretId = secretId;\n      initConfig.secretKey = secretKey;\n    }\n\n    cloudInstance.init(initConfig);\n    dbInstance = cloudInstance.database();\n  }\n  return { cloud: cloudInstance, db: dbInstance };\n}\n\n/**\n * 调用云函数（服务端）\n * POST /api/cloud/[functionName]\n */\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ functionName: string }> }\n) {\n  try {\n    // 初始化云开发并获取数据库实例\n    const { db } = await getCloudDB();\n\n    // Next.js 15+ 中 params 是 Promise\n    const resolvedParams = await params;\n    const functionName = resolvedParams.functionName;\n    const body = await request.json();\n\n    // 根据云函数名称调用对应的云函数\n    if (functionName === \"auth\") {\n      return await handleAuth(body, db);\n    } else if (functionName === \"user\") {\n      return await handleUser(body, db);\n    } else {\n      return NextResponse.json(\n        { success: 0, message: \"未知的云函数\" },\n        { status: 400 }\n      );\n    }\n  } catch (error: any) {\n    console.error(\"调用云函数失败:\", error);\n    return NextResponse.json(\n      { success: 0, message: error.message || \"调用云函数失败\" },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * 处理 auth 云函数\n */\nasync function handleAuth(body: any, db: any) {\n  const { action, phone, password } = body;\n\n  if (action === \"login\") {\n    // 登录即注册：先查找用户，不存在则创建\n    const result = await db\n      .collection(\"users\")\n      .where({\n        phone: phone,\n      })\n      .get();\n\n    let user;\n\n    if (result.data.length === 0) {\n      // 用户不存在，自动创建新用户\n      const today = new Date().toLocaleDateString();\n      const newUser = {\n        phone: phone,\n        password: password, // 实际生产环境应该加密\n        userTier: \"FREE\",\n        sceneUsage: { date: today, count: 0 },\n        memeUsage: { date: today, count: 0 },\n        createdAt: new Date(),\n        updatedAt: new Date(),\n      };\n\n      const addResult = await db.collection(\"users\").add({\n        data: newUser,\n      });\n\n      user = {\n        _id: addResult._id,\n        ...newUser,\n      };\n    } else {\n      // 用户存在，验证密码\n      user = result.data[0];\n      if (user.password !== password) {\n        return NextResponse.json({\n          success: 0,\n          message: \"密码错误\",\n        });\n      }\n    }\n\n    return NextResponse.json({\n      success: 1,\n      data: {\n        userId: user._id,\n        phone: user.phone,\n        userTier: user.userTier || \"FREE\",\n        sceneUsage: user.sceneUsage || {\n          date: new Date().toLocaleDateString(),\n          count: 0,\n        },\n        memeUsage: user.memeUsage || {\n          date: new Date().toLocaleDateString(),\n          count: 0,\n        },\n      },\n    });\n  } else if (action === \"register\") {\n    // 注册\n    // 检查手机号是否已存在\n    const existResult = await db\n      .collection(\"users\")\n      .where({\n        phone: phone,\n      })\n      .get();\n\n    if (existResult.data.length > 0) {\n      return NextResponse.json({\n        success: 0,\n        message: \"该手机号已注册\",\n      });\n    }\n\n    // 创建新用户\n    const today = new Date().toLocaleDateString();\n    const newUser = {\n      phone: phone,\n      password: password, // 实际生产环境应该加密\n      userTier: \"FREE\",\n      sceneUsage: { date: today, count: 0 },\n      memeUsage: { date: today, count: 0 },\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    };\n\n    const addResult = await db.collection(\"users\").add({\n      data: newUser,\n    });\n\n    return NextResponse.json({\n      success: 1,\n      data: {\n        userId: addResult._id,\n        phone: newUser.phone,\n        userTier: newUser.userTier,\n        sceneUsage: newUser.sceneUsage,\n        memeUsage: newUser.memeUsage,\n      },\n    });\n  } else {\n    return NextResponse.json({\n      success: 0,\n      message: \"未知操作\",\n    });\n  }\n}\n\n/**\n * 处理 user 云函数\n */\nasync function handleUser(body: any, db: any) {\n  const { action, userId, increment, userTier } = body;\n\n  if (!userId) {\n    return NextResponse.json({\n      success: 0,\n      message: \"用户ID不能为空\",\n    });\n  }\n\n  const today = new Date().toLocaleDateString();\n\n  if (action === \"getInfo\") {\n    // 获取用户信息\n    const result = await db.collection(\"users\").doc(userId).get();\n\n    if (!result.data) {\n      return NextResponse.json({\n        success: 0,\n        message: \"用户不存在\",\n      });\n    }\n\n    const user = result.data;\n\n    // 检查是否需要重置每日使用量\n    let sceneUsage = user.sceneUsage || { date: today, count: 0 };\n    let memeUsage = user.memeUsage || { date: today, count: 0 };\n\n    if (sceneUsage.date !== today) {\n      sceneUsage = { date: today, count: 0 };\n    }\n    if (memeUsage.date !== today) {\n      memeUsage = { date: today, count: 0 };\n    }\n\n    return NextResponse.json({\n      success: 1,\n      data: {\n        userId: user._id,\n        phone: user.phone,\n        userTier: user.userTier || \"FREE\",\n        sceneUsage: sceneUsage,\n        memeUsage: memeUsage,\n      },\n    });\n  } else if (action === \"updateSceneUsage\") {\n    // 更新场景扩展使用次数\n    const userResult = await db.collection(\"users\").doc(userId).get();\n\n    if (!userResult.data) {\n      return NextResponse.json({\n        success: 0,\n        message: \"用户不存在\",\n      });\n    }\n\n    const user = userResult.data;\n    let sceneUsage = user.sceneUsage || { date: today, count: 0 };\n\n    // 如果日期不同，重置计数\n    if (sceneUsage.date !== today) {\n      sceneUsage = { date: today, count: increment || 1 };\n    } else {\n      sceneUsage.count = (sceneUsage.count || 0) + (increment || 1);\n    }\n\n    await db\n      .collection(\"users\")\n      .doc(userId)\n      .update({\n        data: {\n          sceneUsage: sceneUsage,\n          updatedAt: new Date(),\n        },\n      });\n\n    return NextResponse.json({\n      success: 1,\n      data: {\n        sceneUsage: sceneUsage,\n      },\n    });\n  } else if (action === \"updateMemeUsage\") {\n    // 更新表情包制作使用次数\n    const userResult = await db.collection(\"users\").doc(userId).get();\n\n    if (!userResult.data) {\n      return NextResponse.json({\n        success: 0,\n        message: \"用户不存在\",\n      });\n    }\n\n    const user = userResult.data;\n    let memeUsage = user.memeUsage || { date: today, count: 0 };\n\n    // 如果日期不同，重置计数\n    if (memeUsage.date !== today) {\n      memeUsage = { date: today, count: increment || 1 };\n    } else {\n      memeUsage.count = (memeUsage.count || 0) + (increment || 1);\n    }\n\n    await db\n      .collection(\"users\")\n      .doc(userId)\n      .update({\n        data: {\n          memeUsage: memeUsage,\n          updatedAt: new Date(),\n        },\n      });\n\n    return NextResponse.json({\n      success: 1,\n      data: {\n        memeUsage: memeUsage,\n      },\n    });\n  } else if (action === \"updateTier\") {\n    // 更新用户会员等级\n    await db\n      .collection(\"users\")\n      .doc(userId)\n      .update({\n        data: {\n          userTier: userTier,\n          updatedAt: new Date(),\n        },\n      });\n\n    const userResult = await db.collection(\"users\").doc(userId).get();\n\n    const user = userResult.data;\n\n    return NextResponse.json({\n      success: 1,\n      data: {\n        userId: user._id,\n        phone: user.phone,\n        userTier: user.userTier,\n        sceneUsage: user.sceneUsage || { date: today, count: 0 },\n        memeUsage: user.memeUsage || { date: today, count: 0 },\n      },\n    });\n  } else {\n    return NextResponse.json({\n      success: 0,\n      message: \"未知操作\",\n    });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}
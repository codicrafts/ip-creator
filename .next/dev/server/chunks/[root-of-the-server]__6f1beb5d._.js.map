{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/weili/work/generate-web/app/api/gemini/generate/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\n\nconst API_BASE_URL =\n  \"https://api.laozhang.ai/v1beta/models/gemini-3-pro-image-preview:generateContent\";\n\n/**\n * POST /api/gemini/generate\n * 代理 Gemini API 调用（服务端）\n */\nexport async function POST(request: NextRequest) {\n  try {\n    const API_KEY = process.env.API_KEY || process.env.GEMINI_API_KEY;\n\n    if (!API_KEY) {\n      return NextResponse.json(\n        { error: \"API_KEY is not set\" },\n        { status: 500 }\n      );\n    }\n\n    const body = await request.json();\n    const { contents, generationConfig } = body;\n\n    // 验证请求体\n    if (!contents || !Array.isArray(contents) || contents.length === 0) {\n      return NextResponse.json(\n        { error: \"Invalid request: contents is required and must be an array\" },\n        { status: 400 }\n      );\n    }\n\n    // 构建请求体\n    const requestBody: any = {\n      contents,\n    };\n\n    if (generationConfig) {\n      requestBody.generationConfig = generationConfig;\n    }\n\n    // 验证 API_KEY 格式\n    if (!API_KEY || API_KEY.trim().length === 0) {\n      return NextResponse.json(\n        { error: \"API_KEY is empty or invalid\" },\n        { status: 500 }\n      );\n    }\n\n    // 尝试发送请求\n    let response: Response;\n    try {\n      response = await fetch(API_BASE_URL, {\n        method: \"POST\",\n        headers: {\n          Authorization: `Bearer ${API_KEY.trim()}`,\n          \"Content-Type\": \"application/json\",\n          Accept: \"application/json\",\n        },\n        body: JSON.stringify(requestBody),\n      });\n    } catch (fetchError: any) {\n      console.error(\"Fetch error:\", fetchError);\n      return NextResponse.json(\n        { error: `Network error: ${fetchError.message}` },\n        { status: 500 }\n      );\n    }\n\n    if (!response.ok) {\n      let errorText: string;\n      let errorData: any;\n      try {\n        errorData = await response.json();\n        errorText = JSON.stringify(errorData, null, 2);\n        console.error(\"Gemini API Error Response:\", errorData);\n        console.error(\n          \"Request body (generationConfig):\",\n          JSON.stringify(requestBody.generationConfig, null, 2)\n        );\n      } catch {\n        errorText = await response.text();\n        console.error(\"Gemini API Error Response (text):\", errorText);\n      }\n\n      return NextResponse.json(\n        {\n          error: `API request failed: ${response.status} ${response.statusText}`,\n          details: errorText,\n        },\n        { status: response.status }\n      );\n    }\n\n    const data = await response.json();\n    return NextResponse.json(data);\n  } catch (error: any) {\n    console.error(\"Gemini API Error:\", error);\n    return NextResponse.json(\n      { error: error.message || \"Internal server error\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,eACJ;AAMK,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI,QAAQ,GAAG,CAAC,cAAc;QAEjE,IAAI,CAAC,SAAS;YACZ,OAAO,+QAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAqB,GAC9B;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,QAAQ,EAAE,gBAAgB,EAAE,GAAG;QAEvC,QAAQ;QACR,IAAI,CAAC,YAAY,CAAC,MAAM,OAAO,CAAC,aAAa,SAAS,MAAM,KAAK,GAAG;YAClE,OAAO,+QAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA6D,GACtE;gBAAE,QAAQ;YAAI;QAElB;QAEA,QAAQ;QACR,MAAM,cAAmB;YACvB;QACF;QAEA,IAAI,kBAAkB;YACpB,YAAY,gBAAgB,GAAG;QACjC;QAEA,gBAAgB;QAChB,IAAI,CAAC,WAAW,QAAQ,IAAI,GAAG,MAAM,KAAK,GAAG;YAC3C,OAAO,+QAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA8B,GACvC;gBAAE,QAAQ;YAAI;QAElB;QAEA,SAAS;QACT,IAAI;QACJ,IAAI;YACF,WAAW,MAAM,MAAM,cAAc;gBACnC,QAAQ;gBACR,SAAS;oBACP,eAAe,CAAC,OAAO,EAAE,QAAQ,IAAI,IAAI;oBACzC,gBAAgB;oBAChB,QAAQ;gBACV;gBACA,MAAM,KAAK,SAAS,CAAC;YACvB;QACF,EAAE,OAAO,YAAiB;YACxB,QAAQ,KAAK,CAAC,gBAAgB;YAC9B,OAAO,+QAAY,CAAC,IAAI,CACtB;gBAAE,OAAO,CAAC,eAAe,EAAE,WAAW,OAAO,EAAE;YAAC,GAChD;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,IAAI;YACJ,IAAI;YACJ,IAAI;gBACF,YAAY,MAAM,SAAS,IAAI;gBAC/B,YAAY,KAAK,SAAS,CAAC,WAAW,MAAM;gBAC5C,QAAQ,KAAK,CAAC,8BAA8B;gBAC5C,QAAQ,KAAK,CACX,oCACA,KAAK,SAAS,CAAC,YAAY,gBAAgB,EAAE,MAAM;YAEvD,EAAE,OAAM;gBACN,YAAY,MAAM,SAAS,IAAI;gBAC/B,QAAQ,KAAK,CAAC,qCAAqC;YACrD;YAEA,OAAO,+QAAY,CAAC,IAAI,CACtB;gBACE,OAAO,CAAC,oBAAoB,EAAE,SAAS,MAAM,CAAC,CAAC,EAAE,SAAS,UAAU,EAAE;gBACtE,SAAS;YACX,GACA;gBAAE,QAAQ,SAAS,MAAM;YAAC;QAE9B;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAChC,OAAO,+QAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,qBAAqB;QACnC,OAAO,+QAAY,CAAC,IAAI,CACtB;YAAE,OAAO,MAAM,OAAO,IAAI;QAAwB,GAClD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}